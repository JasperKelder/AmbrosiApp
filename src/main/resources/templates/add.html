<!DOCTYPE HTML>
<html lang="en" xmlns:th="https://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <title>EatAndTreat - Add</title>
    <div th:replace="fragments/head :: head"></div>
    <!--    Insert jquery
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>-->
</head>
<body>
<sec:authorize access="hasRole('ROLE_ADMIN') and hasRole('ROLE_USER')">
    <!--Navigation-->
    <nav th:replace="fragments/navigation :: navigation"></nav>
    <!--Main page-->
    <div class="flex-container">
        <div class="spaceMedium"></div>
        <div class="addContainer color">
            <!--Add recipe form-->
            <form th:action="@{/add}" th:object="${recipe}" method="post" enctype="multipart/form-data" autocomplete="off">
                <div hidden><input type="text" th:field="*{recipeId}"/></div>
                <div class="row">
                    <div class="column-left">
                        <label for="title">Title</label>
                    </div>
                    <div class="column-right">
                        <input type="text" id="title" name="title" th:field="*{recipeTitle}"
                               required placeholder="Title"/>
                    </div>
                </div>
                <div class="row">
                    <div class="column-left">
                        <label for="preparation">Preparation</label>
                    </div>
                    <div class="column-right">
                        <textarea id="preparation" name="preparation" th:field="*{recipePreperation}" required
                                  placeholder="Preparation"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="column-left">
                        <label for="preparationtime">Prep-time</label>
                    </div>
                    <div class="column-right">
                        <input type="number" id="preparationtime" name="preparationtime"
                               th:field="*{preperationTime}"
                               required placeholder="Prep-time"/>
                    </div>
                </div>
                <div class="row">
                    <div class="column-left">
                        <label for="servings">Servings</label>
                    </div>
                    <div class="column-right">
                        <input type="number" id="servings" name="servings" th:field="*{servings}" required
                               placeholder="Servings"/>
                    </div>
                </div>
                <div class="row">
                    <div class="column-left">
                        <label>Ingredients</label>
                    </div>
                    <div class="column-right">



                        <div id="element-wrapper">

                             <div id="rowIngredients">
                                 <div class="autocomplete">
                                     <input id="myInput" type="text" name="ingredientName">
                                     <input id="myIngredients" type="hidden" th:value="${allIngredientsJson}">
                                 </div>
                             </div>
                         </div>
                        <button id="removeRow" type="button">Remove row</button>
                        <button id="addRow" type="button">Add new row</button>

                        <script type="text/javascript">
                            document.getElementById('addRow').onclick = function() {
                                var container = document.getElementById("rowIngredients");
                                document.getElementById("element-wrapper").appendChild(container.cloneNode(true));
                            }

                            document.getElementById('removeRow').onclick = function () {
                                if (document.getElementById('element-wrapper').childElementCount > 1) {
                                    var container = document.getElementById('element-wrapper');
                                    container.removeChild(container.lastChild);
                                }
                            }
                        </script>

                        <script type="text/javascript">

                            function autocomplete(inp, arr) {
                                /*the autocomplete function takes two arguments,
                                the text field element and an array of possible autocompleted values:*/
                                var currentFocus;
                                /*execute a function when someone writes in the text field:*/
                                inp.addEventListener("input", function(e) {
                                    var a, b, i, val = this.value;
                                    /*close any already open lists of autocompleted values*/
                                    closeAllLists();
                                    if (!val) { return false;}
                                    currentFocus = -1;
                                    /*create a DIV element that will contain the items (values):*/
                                    a = document.createElement("DIV");
                                    a.setAttribute("id", this.id + "autocomplete-list");
                                    a.setAttribute("class", "autocomplete-items");
                                    /*append the DIV element as a child of the autocomplete container:*/
                                    this.parentNode.appendChild(a);
                                    /*for each item in the array...*/
                                    for (i = 0; i < arr.length; i++) {
                                        /*check if the item starts with the same letters as the text field value:*/
                                        if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                                            /*create a DIV element for each matching element:*/
                                            b = document.createElement("DIV");
                                            /*make the matching letters bold:*/
                                            b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                                            b.innerHTML += arr[i].substr(val.length);
                                            /*insert a input field that will hold the current array item's value:*/
                                            b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                                            /*execute a function when someone clicks on the item value (DIV element):*/
                                            b.addEventListener("click", function(e) {
                                                /*insert the value for the autocomplete text field:*/
                                                inp.value = this.getElementsByTagName("input")[0].value;
                                                /*close the list of autocompleted values,
                                                (or any other open lists of autocompleted values:*/
                                                closeAllLists();
                                            });
                                            a.appendChild(b);
                                        }
                                    }
                                });
                                /*execute a function presses a key on the keyboard:*/
                                inp.addEventListener("keydown", function(e) {
                                    var x = document.getElementById(this.id + "autocomplete-list");
                                    if (x) x = x.getElementsByTagName("div");
                                    if (e.keyCode == 40) {
                                        /*If the arrow DOWN key is pressed,
                                        increase the currentFocus variable:*/
                                        currentFocus++;
                                        /*and and make the current item more visible:*/
                                        addActive(x);
                                    } else if (e.keyCode == 38) { //up
                                        /*If the arrow UP key is pressed,
                                        decrease the currentFocus variable:*/
                                        currentFocus--;
                                        /*and and make the current item more visible:*/
                                        addActive(x);
                                    } else if (e.keyCode == 13) {
                                        /*If the ENTER key is pressed, prevent the form from being submitted,*/
                                        e.preventDefault();
                                        if (currentFocus > -1) {
                                            /*and simulate a click on the "active" item:*/
                                            if (x) x[currentFocus].click();
                                        }
                                    }
                                });
                                function addActive(x) {
                                    /*a function to classify an item as "active":*/
                                    if (!x) return false;
                                    /*start by removing the "active" class on all items:*/
                                    removeActive(x);
                                    if (currentFocus >= x.length) currentFocus = 0;
                                    if (currentFocus < 0) currentFocus = (x.length - 1);
                                    /*add class "autocomplete-active":*/
                                    x[currentFocus].classList.add("autocomplete-active");
                                }
                                function removeActive(x) {
                                    /*a function to remove the "active" class from all autocomplete items:*/
                                    for (var i = 0; i < x.length; i++) {
                                        x[i].classList.remove("autocomplete-active");
                                    }
                                }
                                function closeAllLists(elmnt) {
                                    /*close all autocomplete lists in the document,
                                    except the one passed as an argument:*/
                                    var x = document.getElementsByClassName("autocomplete-items");
                                    for (var i = 0; i < x.length; i++) {
                                        if (elmnt != x[i] && elmnt != inp) {
                                            x[i].parentNode.removeChild(x[i]);
                                        }
                                    }
                                }
                                /*execute a function when someone clicks in the document:*/
                                document.addEventListener("click", function (e) {
                                    closeAllLists(e.target);
                                });
                            }

                            var ingredientsString = document.getElementById("myIngredients").value;

                            var ingredientsArray = JSON.parse(ingredientsString);

                            autocomplete(document.getElementById("myInput"), ingredientsArray);


                        </script>

                    </div>
                </div>
                <div class="row">
                    <div class="column-left">
                        <label for="cooktime">Cook-time</label>
                    </div>
                    <div class="column-right">
                        <input type="number" id="cooktime" name="cooktime" th:field="*{cooktime}" required
                               placeholder="Cook-time"/>
                    </div>
                </div>
                <div class="row">
                    <div class="column-left">
                        <label for="cuisine">Cuisine</label>
                    </div>
                    <div class="column-right">
                        <select id="cuisine" name="cuisine" th:field="*{cuisineName}" required>
                            <!--Dropdown box displaying all cuisines-->
                            <option th:each="cuisine : ${allCuisines}"
                                    th:value="${cuisine.cuisineId}"
                                    th:text="${cuisine.cuisineName}">
                            </option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="column-left">
                        <label for="category">Category</label>
                    </div>
                    <div class="column-right">
                        <select id="category" name="category" th:field="*{categoryName}" required>
                            <!--Dropdown box displaying all categories-->
                            <option th:each="category : ${allCategories}"
                                    th:value="${category.categoryId}"
                                    th:text="${category.categoryName}">
                            </option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="column-left">
                        <label for="file">Image</label>
                    </div>
                    <div class="column-right">
                        <input type="file" name="file" id="file" onchange="FileValidation()"
                               th:placeholder="|data:image/jpeg;base64,${currentImage}|">
                    </div>
                </div>
                <div th:unless="${currentImage} == null">
                    <div class="row">Current image:</div>
                    <img th:src="|data:image/jpeg;base64,${currentImage}|"/>
                </div>
                <div class="row">
                    <input id="floatrightbutton" type="submit" value="Submit">
                </div>
            </form>
        </div>
    </div>
    <div class="spaceMedium"></div>
</sec:authorize>
<script type="text/javascript" src="script/fileUploadCheck.js"></script>
</body>
</html>